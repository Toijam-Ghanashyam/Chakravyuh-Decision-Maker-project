name: Deploy Supabase Edge Functions

on:
  workflow_dispatch: {}
  push:
    paths:
      - 'supabase/functions/**'

jobs:
  deploy-functions:
    runs-on: ubuntu-latest
    permissions:
      contents: read

    steps:
      - name: Checkout repository
        uses: actions/checkout@v4

      # --------------------------------------------------------
      # FIX: Use the official action instead of manual wget/rm
      # This installs the CLI safely without deleting your files.
      # --------------------------------------------------------
      - name: Setup Supabase CLI
        uses: supabase/setup-cli@v1
        with:
          version: latest

      - name: Deploy Edge Functions
        env:
          # The CLI automatically detects these env vars.
          # You do NOT need 'supabase login' explicitly.
          SUPABASE_ACCESS_TOKEN: ${{ secrets.SUPABASE_ACCESS_TOKEN }}
          SUPABASE_PROJECT_ID: ${{ secrets.SUPABASE_REF }}
        run: |
          if [ -z "$SUPABASE_PROJECT_ID" ]; then
            echo "ERROR: SUPABASE_REF (mapped to SUPABASE_PROJECT_ID) is not set."
            exit 1
          fi
          
          # Deploy using the project ID variable
          supabase functions deploy ai-chat --project-ref "$SUPABASE_PROJECT_ID"
          supabase functions deploy extract-doc --project-ref "$SUPABASE_PROJECT_ID"

      - name: Deployment Complete
        run: echo "Deployment finished."
